<!DOCTYPE html>
<!--[if lt IE 7]><html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]--><!--[if (IE 7)&!(IEMobile)]><html class="no-js lt-ie9 lt-ie8"><![endif]--><!--[if (IE 8)&!(IEMobile)]><html class="no-js lt-ie9"><![endif]--><!--[if gt IE 8]><!--><html class="no-js">
<!--<![endif]--><head>
<meta charset="UTF-8">
<meta content="text/html; charset=UTF-8" http-equiv="Content-Type">
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
<title>Beware: Using Javascript's Block Scope as an IIFE can be... Iffy – Rob Porter</title>
<meta name="description" content="Digital Naturalist">
<meta name="keywords" content="Javascript, ES6, transpiling, Node.js, IIFE, Angular.js, Programming">
<!-- Twitter Cards --><meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="http://localhost:4000//assets/img/tychoInst6.gif">
<meta name="twitter:title" content="Beware: Using Javascript's Block Scope as an IIFE can be... Iffy">
<meta name="twitter:description" content="Many assume this ES6 feature is equivalent to an IIFE, but it can be quite leaky if you’re not careful">
<meta name="twitter:site" content="@rgeraldporter">
<meta name="twitter:creator" content="@rgeraldporter">
<!-- Open Graph --><meta property="og:locale" content="en_CA">
<meta property="og:type" content="article">
<meta property="og:title" content="Beware: Using Javascript's Block Scope as an IIFE can be... Iffy">
<meta property="og:description" content="Many assume this ES6 feature is equivalent to an IIFE, but it can be quite leaky if you’re not careful">
<meta property="og:url" content="http://localhost:4000/block-scope-is-not-an-iife/">
<meta property="og:site_name" content="Rob Porter">
<meta property="og:image" content="http://localhost:4000/assets/img/feather-7.svg">
<link rel="canonical" href="http://localhost:4000/block-scope-is-not-an-iife/">
<link href="http://localhost:4000/feed.xml" type="application/atom+xml" rel="alternate" title="Rob Porter Feed">
<!-- Handheld --><meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<!-- CSS --><link rel="stylesheet" href="http://localhost:4000/assets/css/main.css">
<!-- JS --><script src="http://localhost:4000/assets/js/modernizr-3.3.1.custom.min.js"></script><!-- Favicons --><link rel="apple-touch-icon" href="http://localhost:4000/assets/img/favicons/apple-icon-precomposed.png">
<link rel="apple-touch-icon" sizes="72x72" href="http://localhost:4000/assets/img/favicons/apple-icon-72x72.png">
<link rel="apple-touch-icon" sizes="114x114" href="http://localhost:4000/assets/img/favicons/apple-icon-114x114.png">
<link rel="apple-touch-icon" sizes="144x144" href="http://localhost:4000/assets/img/favicons/apple-icon-144x144.png">
<link rel="shortcut icon" type="image/png" href="http://localhost:4000/favicon.png">
<link rel="shortcut icon" href="http://localhost:4000/favicon.ico">
<!-- Background Image --><style type="text/css">body {background-image:url(http://localhost:4000/assets/img/sunset-big.jpg); background-repeat: no-repeat; background-size: cover; }</style>
<!-- Post Feature Image --><style type="text/css">.feature {background-image:url(http://localhost:4000//assets/img/tychoInst6.gif);}</style>
</head>
<body> <nav id="dl-menu" class="dl-menuwrapper" role="navigation"><button class="dl-trigger">Open Menu</button> <ul class="dl-menu">
<li><a href="http://localhost:4000/">Home</a></li> <!--li> <a href="#">About</a> <ul class="dl-submenu"> <li> <img src="http://localhost:4000/assets/img/feather-7.svg" alt="Rob Porter photo" class="author-photo"> <h4>Rob Porter</h4> <p>Digital Naturalist</p> </li> <li><a href="http://localhost:4000/about/"><span class="btn btn-inverse">Learn More</span></a></li> <li> <a href="http://twitter.com/rgeraldporter" target="_blank" rel="noopener noreferrer"><i class="fa fa-fw fa-twitter-square"></i> Twitter</a> </li> <li> <a href="http://linkedin.com/in/rgeraldporter" target="_blank" rel="noopener noreferrer"><i class="fa fa-fw fa-linkedin-square"></i> LinkedIn</a> </li> <li> <a href="http://instagram.com/rgeraldporter" target="_blank" rel="noopener noreferrer"><i class="fa fa-fw fa-instagram"></i> Instagram</a> </li> <li> <a href="http://github.com/rgeraldporter" target="_blank" rel="noopener noreferrer"><i class="fa fa-fw fa-github"></i> Github</a> </li> <li> <a href="http://stackoverflow.com/users/325674/rob-porter" target="_blank" rel="noopener noreferrer"><i class="fa fa-fw fa-stack-overflow"></i> StackOverflow</a> </li> </ul><!-- /.dl-submenu --> <!--/li--> <li> <a href="#">Posts</a> <ul class="dl-submenu">
<li><a href="http://localhost:4000/posts/">All Posts</a></li> <li><a href="http://localhost:4000/tags/">All Tags</a></li> </ul>
</li> <li><a href="http://localhost:4000/projects/">Projects</a></li> </ul>
<!-- /.dl-menu --></nav><!-- /.dl-menuwrapper --><!-- Header --><header class="header" role="banner"><div class="wrapper animated fadeIn"> <div class="content"> <div class="post-title feature "> <h1>Beware: Using Javascript's Block Scope as an IIFE can be... Iffy</h1> <h4>22 Feb 2017</h4> <a class="btn zoombtn" href="http://localhost:4000/posts/"> <i class="fa fa-chevron-left"></i> </a> </div> <p>The advent of <a href="http://es6-features.org/" target="_blank">ES6 Javascript</a> brought many game-changing features that were desperately needed in the language. The introduction of <code class="highlighter-rouge">let</code> and <code class="highlighter-rouge">const</code> are especially important, as they allowed for better control over variables and scoping.</p> <p>Another celebrated new feature was the introduction of <strong>block scoping</strong>, which allows you to wrap any arbitrary piece of code in braces to indicate, well, a block scope.</p> <p>Countless <a href="https://jack.ofspades.com/es6-iife-with-fat-arrow-functions/" target="_blank">guides</a> <a href="http://wesbos.com/es6-block-scope-iife/" target="_blank">out there</a> <a href="https://medium.freecodecamp.com/5-javascript-bad-parts-that-are-fixed-in-es6-c7c45d44fd81#.pvazi981g" target="_blank">tout this</a> <a href="http://www.benmvp.com/learning-es6-block-level-scoping-let-const/" target="_blank">as the successor</a> to the <strong>immediately-invoked function expression</strong> (IIFE) – normally used to isolate the scope of a given block of Javascript.</p> <p>However, there are a series of conditions that need to be met in order to fulfill block scope’s destiny to become the fill-in for the awkward IIFE.</p> <h2 id="leaky-functions">Leaky functions</h2> <p>Out of the box, if you were to use block scope right now on Chrome, Safari, or Firefox (and likely other browsers and Node.js), there are some problems with block scope being leaky.</p> <p>These issues begin to emerge when you attempt to use a block to scope a declared function. For example:</p> <figure class="highlight"><pre><code class="language-js" data-lang="js"><span class="c1">// IIFE</span>
<span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">function</span> <span class="nx">foo</span> <span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">})();</span>

<span class="c1">// fails, as foo() is undefined outside of the IIFE</span>
<span class="nx">foo</span><span class="p">();</span></code></pre></figure><p>as compared with:</p> <figure class="highlight"><pre><code class="language-js" data-lang="js"><span class="c1">// block scope</span>
<span class="p">{</span>
    <span class="kd">function</span> <span class="nx">foo</span> <span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="c1">// returns "true", is accessible</span>
<span class="nx">foo</span><span class="p">();</span></code></pre></figure><p>The solution to this problem, is to force the Javascript runtime into “strict” mode, in the scope of where the block scope is declared. Like this:</p> <p>as compared with:</p> <figure class="highlight"><pre><code class="language-js" data-lang="js"><span class="s1">'use strict'</span><span class="p">;</span>
<span class="c1">// block scope</span>
<span class="p">{</span>
    <span class="kd">function</span> <span class="nx">foo</span> <span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="c1">// throws an error</span>
<span class="nx">foo</span><span class="p">();</span></code></pre></figure><h2 id="context-is-key">Context is key</h2> <p>Most discussions about block scoping are specifically referencing the use of <code class="highlighter-rouge">const</code> and <code class="highlighter-rouge">let</code> declarations within a block. This is the case where the block scope shines, out-of-the-box, without any stict mode: the ES6 declarations of <code class="highlighter-rouge">let</code>, <code class="highlighter-rouge">const</code>, and even <code class="highlighter-rouge">class</code> never leak outside of the scope.</p> <p>Let’s see what happens when I rewrite <code class="highlighter-rouge">foo()</code> as a <strong>constant function expression</strong> (CFE… can I coin that?):</p> <figure class="highlight"><pre><code class="language-js" data-lang="js"><span class="p">{</span>
    <span class="kr">const</span> <span class="nx">foo</span> <span class="o">=</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="kc">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// fails, is undefined outside of the block scope</span>
<span class="nx">foo</span><span class="p">();</span></code></pre></figure><p>However, keeping declared functions (using the <code class="highlighter-rouge">function</code> keyword) contained within the block scope requires strict mode to be enabled, and that isn’t usually mentioned in guides that discuss using this technique.</p> <p>Also of note: <code class="highlighter-rouge">var</code> will never contain itself within a block scope, no matter what you try. It will always leak out, and while there’s not really any great reasons to use <code class="highlighter-rouge">var</code> any longer, as you’ll see shortly, transpilers still do.</p> <h2 id="transpiling-with-babel-and-traceur">Transpiling with Babel and Traceur</h2> <p>If you’re writing client-side ES6 code, even with the high levels of compliance we’re starting to see today, you’re still likely to be transpiling down to ES5.</p> <p>Transpilers work to make your code work as closely to perfect as possible in an older version of Javascript. Usually this amounts to something less efficient being used – it’s usually not something that a developer would notice any difference in behaviour.</p> <p>Oddly, block scoping in <a href="https://babeljs.io/" target="_blank">Babel</a> is one of those rare cases where things do act differently.</p> <p>A practical example would be taking some Angular 1.x code, and instead of wrapping a file with an IIFE, let’s wrap it with block scoping:</p> <figure class="highlight"><pre><code class="language-js" data-lang="js"><span class="s1">'use strict'</span><span class="p">;</span>
<span class="p">{</span>
    <span class="nx">angular</span>
        <span class="p">.</span><span class="nx">module</span><span class="p">(</span> <span class="s1">'myModule'</span> <span class="p">)</span>
        <span class="p">.</span><span class="nx">component</span><span class="p">(</span> <span class="s1">'myFoo'</span><span class="p">,</span> <span class="p">{</span>
            <span class="na">templateUrl</span><span class="p">:</span> <span class="s1">'/templates/components/foo.html'</span><span class="p">,</span>
            <span class="na">bindings</span>   <span class="p">:</span> <span class="p">{},</span>
            <span class="na">controller</span> <span class="p">:</span> <span class="nx">Foo</span>
        <span class="p">}</span> <span class="p">);</span>

    <span class="nx">Foo</span><span class="p">.</span><span class="nx">$inject</span> <span class="o">=</span> <span class="p">[</span> <span class="s1">'Something'</span> <span class="p">];</span>

    <span class="kd">function</span> <span class="nx">Foo</span><span class="p">(</span> <span class="nx">Something</span> <span class="p">)</span> <span class="p">{</span>
      <span class="c1">// do stuff</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre></figure><p>Run this through Babel (in ES2015/ES6 mode), and the result is:</p> <figure class="highlight"><pre><code class="language-js" data-lang="js"><span class="s1">'use strict'</span><span class="p">;</span>

<span class="p">{</span>
    <span class="kd">var</span> <span class="nx">Foo</span> <span class="o">=</span> <span class="kd">function</span> <span class="nx">Foo</span><span class="p">(</span><span class="nx">Something</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// do stuff</span>
    <span class="p">};</span>

    <span class="nx">angular</span><span class="p">.</span><span class="nx">module</span><span class="p">(</span><span class="s1">'myModule'</span><span class="p">).</span><span class="nx">component</span><span class="p">(</span><span class="s1">'myFoo'</span><span class="p">,</span> <span class="p">{</span>
        <span class="na">templateUrl</span><span class="p">:</span> <span class="s1">'/templates/components/foo.html'</span><span class="p">,</span>
        <span class="na">bindings</span><span class="p">:</span> <span class="p">{},</span>
        <span class="na">controller</span><span class="p">:</span> <span class="nx">Foo</span>
    <span class="p">});</span>

    <span class="nx">Foo</span><span class="p">.</span><span class="nx">$inject</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'Something'</span><span class="p">];</span>
<span class="p">}</span></code></pre></figure><p><strong>Note that the function declaration is now a function expression, using <code class="highlighter-rouge">var</code>.</strong> Unfortunately, <code class="highlighter-rouge">var</code> leaks out of block scope by design (it is function scoped, not block scoped), and the whole point of wrapping the file in an IIFE is lost as the function now lives in global scope.</p> <p>Running this through an alternative, <a href="https://github.com/google/traceur-compiler" target="_blank">Traceur</a>, basically results in the same thing:</p> <figure class="highlight"><pre><code class="language-js" data-lang="js"><span class="nx">$traceurRuntime</span><span class="p">.</span><span class="nx">ModuleStore</span><span class="p">.</span><span class="nx">getAnonymousModule</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="s2">"use strict"</span><span class="p">;</span>
  <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">Foo</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">Something</span><span class="p">)</span> <span class="p">{};</span>
    <span class="nx">angular</span><span class="p">.</span><span class="nx">module</span><span class="p">(</span><span class="s1">'myModule'</span><span class="p">).</span><span class="nx">component</span><span class="p">(</span><span class="s1">'myFoo'</span><span class="p">,</span> <span class="p">{</span>
      <span class="na">templateUrl</span><span class="p">:</span> <span class="s1">'/templates/components/foo.html'</span><span class="p">,</span>
      <span class="na">bindings</span><span class="p">:</span> <span class="p">{},</span>
      <span class="na">controller</span><span class="p">:</span> <span class="nx">Foo</span>
    <span class="p">});</span>
    <span class="nx">Foo</span><span class="p">.</span><span class="nx">$inject</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'Something'</span><span class="p">];</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="p">{};</span>
<span class="p">});</span></code></pre></figure><p>Why Babel and Traceur don’t just convert the block into an IIFE, I’m not sure. Certainly if you’ve declared you’d like the block handled strictly, I would think that is enough to infer that transpiling it to an IIFE.</p> <p>For Babel, the only way to get a more correct result is to use the ES2016 setting, however that may be making too much of an assumption about the freshness of your users browsers.</p> <p>In coming years, block scope is certain to replace the need for IIFEs. Until that time, however, be very careful about using them, and to use them effectively and without side-effects, don’t make assumptions – make good tests.<img src="http://robporter.ca/assets/img/feather-7.svg" style="width:33px;height:33px;display:inline;padding-left:6px"></p> <ul>
<li>For reference, a quick test you can run to reveal a function leaking from block scope: <a href="https://gist.github.com/rgeraldporter/3f94db1d0b5515789c9675cb659b7cc3" target="_blank">blockscope.js</a>
</li> </ul>
<div class="entry-meta"> <br><hr>
<span class="entry-tags"><a href="http://localhost:4000/tags/#Javascript" title="Pages tagged Javascript" class="tag"><span class="term">Javascript</span></a><a href="http://localhost:4000/tags/#ES6" title="Pages tagged ES6" class="tag"><span class="term">ES6</span></a><a href="http://localhost:4000/tags/#transpiling" title="Pages tagged transpiling" class="tag"><span class="term">transpiling</span></a><a href="http://localhost:4000/tags/#Node.js" title="Pages tagged Node.js" class="tag"><span class="term">Node.js</span></a><a href="http://localhost:4000/tags/#IIFE" title="Pages tagged IIFE" class="tag"><span class="term">IIFE</span></a><a href="http://localhost:4000/tags/#Angular.js" title="Pages tagged Angular.js" class="tag"><span class="term">Angular.js</span></a><a href="http://localhost:4000/tags/#Programming" title="Pages tagged Programming" class="tag"><span class="term">Programming</span></a></span> <span class="social-share"> <a href="https://www.facebook.com/sharer/sharer.php?u=http://localhost:4000/block-scope-is-not-an-iife/" title="Share on Facebook" class="tag"> <span class="term"><i class="fa fa-facebook-square"></i> Like</span> </a> <a href="https://twitter.com/intent/tweet?text=http://localhost:4000/block-scope-is-not-an-iife/" title="Share on Twitter" class="tag"> <span class="term"><i class="fa fa-twitter-square"></i> Tweet</span> </a> <a href="https://plus.google.com/share?url=http://localhost:4000/block-scope-is-not-an-iife/" title="Share on Google+" class="tag"> <span class="term"><i class="fa fa-google-plus-square"></i> +1</span> </a> </span> <div style="clear:both"></div> </div> </div> </div> </header><!-- JS --><script src="http://localhost:4000/assets/js/jquery-1.12.0.min.js"></script><script src="http://localhost:4000/assets/js/jquery.dlmenu.min.js"></script><script src="http://localhost:4000/assets/js/jquery.goup.min.js"></script><script src="http://localhost:4000/assets/js/jquery.magnific-popup.min.js"></script><script src="http://localhost:4000/assets/js/jquery.fitvid.min.js"></script><script src="http://localhost:4000/assets/js/scripts.js"></script><!-- MathJax --><script async src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
</body>
</html>
