<!DOCTYPE html>
<!--[if lt IE 7]><html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]--><!--[if (IE 7)&!(IEMobile)]><html class="no-js lt-ie9 lt-ie8"><![endif]--><!--[if (IE 8)&!(IEMobile)]><html class="no-js lt-ie9"><![endif]--><!--[if gt IE 8]><!--><html class="no-js">
<!--<![endif]--> <head> <meta charset="UTF-8"> <meta content="text/html; charset=UTF-8" http-equiv="Content-Type"> <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"> <title>Extracting Test Results from CucumberJs in Jenkins Pipeline Syntax – Rob Porter</title> <meta name="description" content="Digital Naturalist"> <meta name="keywords" content="Groovy, Jenkins, Java, E2E, Cucumber"> <!-- Twitter Cards --> <meta name="twitter:card" content="summary_large_image"> <meta name="twitter:image" content="http://localhost:4000//assets/img/fibonacci.jpg"> <meta name="twitter:title" content="Extracting Test Results from CucumberJs in Jenkins Pipeline Syntax"> <meta name="twitter:description" content="Get data out of a Jenkins job."> <meta name="twitter:site" content="@rgeraldporter"> <meta name="twitter:creator" content="@rgeraldporter"> <!-- Open Graph --> <meta property="og:locale" content="en_CA"> <meta property="og:type" content="article"> <meta property="og:title" content="Extracting Test Results from CucumberJs in Jenkins Pipeline Syntax"> <meta property="og:description" content="Get data out of a Jenkins job."> <meta property="og:url" content="http://localhost:4000/jenkins-cucumber/"> <meta property="og:site_name" content="Rob Porter"> <meta property="og:image" content="http://localhost:4000/assets/img/feather-7.svg"> <link rel="canonical" href="http://localhost:4000/jenkins-cucumber/"> <link href="http://localhost:4000/feed.xml" type="application/atom+xml" rel="alternate" title="Rob Porter Feed"> <!-- Handheld --> <meta name="HandheldFriendly" content="True"> <meta name="MobileOptimized" content="320"> <meta name="viewport" content="width=device-width, initial-scale=1.0"> <!-- CSS --> <link rel="stylesheet" href="http://localhost:4000/assets/css/main.css"> <!-- JS --> <script src="http://localhost:4000/assets/js/modernizr-3.3.1.custom.min.js"></script> <!-- Favicons --> <link rel="apple-touch-icon" href="http://localhost:4000/assets/img/favicons/apple-icon-precomposed.png"> <link rel="apple-touch-icon" sizes="72x72" href="http://localhost:4000/assets/img/favicons/apple-icon-72x72.png"> <link rel="apple-touch-icon" sizes="114x114" href="http://localhost:4000/assets/img/favicons/apple-icon-114x114.png"> <link rel="apple-touch-icon" sizes="144x144" href="http://localhost:4000/assets/img/favicons/apple-icon-144x144.png"> <link rel="shortcut icon" type="image/png" href="http://localhost:4000/favicon.png"> <link rel="shortcut icon" href="http://localhost:4000/favicon.ico"> <!-- Background Image --> <style type="text/css">body {background-image:url(http://localhost:4000/assets/img/sunset-big.jpg); background-repeat: no-repeat; background-size: cover; }</style> <!-- Post Feature Image --> <style type="text/css">.feature {background-image:url(http://localhost:4000//assets/img/fibonacci.jpg);}</style> </head> <body> <nav id="dl-menu" class="dl-menuwrapper" role="navigation"> <button class="dl-trigger">Open Menu</button> <ul class="dl-menu"> <li><a href="http://localhost:4000/">Home</a></li> <!--li> <a href="#">About</a> <ul class="dl-submenu"> <li> <img src="http://localhost:4000/assets/img/feather-7.svg" alt="Rob Porter photo" class="author-photo"> <h4>Rob Porter</h4> <p>Digital Naturalist</p> </li> <li><a href="http://localhost:4000/about/"><span class="btn btn-inverse">Learn More</span></a></li> <li> <a href="http://twitter.com/rgeraldporter" target="_blank" rel="noopener noreferrer"><i class="fa fa-fw fa-twitter-square"></i> Twitter</a> </li> <li> <a href="http://linkedin.com/in/rgeraldporter" target="_blank" rel="noopener noreferrer"><i class="fa fa-fw fa-linkedin-square"></i> LinkedIn</a> </li> <li> <a href="http://instagram.com/rgeraldporter" target="_blank" rel="noopener noreferrer"><i class="fa fa-fw fa-instagram"></i> Instagram</a> </li> <li> <a href="http://github.com/rgeraldporter" target="_blank" rel="noopener noreferrer"><i class="fa fa-fw fa-github"></i> Github</a> </li> <li> <a href="http://stackoverflow.com/users/325674/rob-porter" target="_blank" rel="noopener noreferrer"><i class="fa fa-fw fa-stack-overflow"></i> StackOverflow</a> </li> </ul><!-- /.dl-submenu --> <!--/li--> <li> <a href="#">Posts</a> <ul class="dl-submenu"> <li><a href="http://localhost:4000/posts/">All Posts</a></li> <li><a href="http://localhost:4000/tags/">All Tags</a></li> </ul> </li> <li><a href="http://localhost:4000/projects/">Projects</a></li> </ul>
<!-- /.dl-menu --> </nav><!-- /.dl-menuwrapper --> <!-- Header --> <header class="header" role="banner"> <div class="wrapper animated fadeIn"> <div class="content"> <div class="post-title feature "> <h1>Extracting Test Results from CucumberJs in Jenkins Pipeline Syntax</h1> <h4>03 Jun 2019</h4> <a class="btn zoombtn" href="http://localhost:4000/posts/"> <i class="fa fa-chevron-left"></i> </a> </div> <p>Jenkins can be a powerful system for Continuous Integration (CI) services, allowing automation of complex tasks, such as running an end-to-end (E2E) test suite within a Dockerized environment.</p> <p>You don’t automatically get useful data out of Jenkins jobs, however. Perhaps you want to take results from an E2E run and feed them into Slack, notify a monitor on a service like Datadog when there are test failures. You might also want to use the results to inform the successs/failure report of the Jenkins job itself.</p> <h2 id="assumptions">Assumptions</h2> <p>This guide assumes you’re using <code class="highlighter-rouge">cucumber-js</code> (v5.1.0 as of this writing), and <code class="highlighter-rouge">cucumber-html-reporter</code> (v5.0.0) in a Jenkins Pipeline job. If you are using another reporter, as long as you have a resulting file with data to extract, you may be able to use this guide with some adjustments.</p> <p>This was designed around an E2E solution that runs tests entirely in Docker, and concludes by using <code class="highlighter-rouge">docker cp</code> to copy the resulting HTML report to the Jenkins job workspace.</p> <p>Our <code class="highlighter-rouge">Jenkinsfile</code> will be using the Jenkins <a href="https://jenkins.io/doc/book/pipeline/syntax/#scripted-pipeline">Scripted Pipeline Syntax</a>, which is built with Groovy. You won’t need to know much about Groovy as it’s similar enough to JS for what we’re doing. Groovy is a (<a href="https://stackoverflow.com/questions/4272068/is-groovy-syntax-an-exact-superset-of-java-syntax/4274542">sort of</a>) superset of Java, and we’re going to take advantage of that in this method.</p> <h2 id="method">Method</h2> <p>As our method for extraction, we’re going to parse the HTML file that results, find the two lines that contain the pass and failure results, then use some light regex matching to hone in on those exact integers.</p> <p>This may seem a bit awkward, but parsing the raw <code class="highlighter-rouge">cucumber-report.json</code> file would be far, far more work as we’d have to recalculate the results.</p> <h2 id="implementation">Implementation</h2> <p>At the top of our <code class="highlighter-rouge">Jenkinsfile</code> let’s declare some variables we’ll be using in this script.</p> <div class="language-groovy highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">#</span><span class="o">!</span><span class="n">groovy</span>

<span class="kt">int</span> <span class="n">e2ePassed</span> <span class="o">=</span> <span class="mi">0</span>
<span class="kt">int</span> <span class="n">e2eFailed</span> <span class="o">=</span> <span class="mi">0</span>
<span class="kt">int</span> <span class="n">e2eTotal</span>
<span class="kt">int</span> <span class="n">e2ePercent</span>

<span class="n">pipeline</span> <span class="o">{</span>
<span class="o">(</span> <span class="o">...</span> <span class="o">)</span>
</code></pre></div></div> <p>Somewhere down the line, when our main task of running tests is complete, we’ll be generating an artifact from the Cucumber JS HTML report.</p> <p>I’ve used comments below to document what each line is responsible for.</p> <div class="language-groovy highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">steps</span> <span class="o">{</span>

    <span class="cm">/*
     run test, copy the report file out of docker or where ever it is...
    */</span>

    <span class="n">archiveArtifacts</span> <span class="nl">artifacts:</span> <span class="s2">"cucumber_report.html"</span><span class="o">,</span> <span class="nl">fingerprint:</span> <span class="kc">true</span>

    <span class="c1">// our Groovy script will be contained in this scope</span>
    <span class="n">script</span> <span class="o">{</span>
        <span class="n">println</span> <span class="o">(</span><span class="s1">'Extracting passed &amp; failed values'</span><span class="o">)</span>

        <span class="c1">// get the present working directory (PWD)</span>
        <span class="n">String</span> <span class="n">PWD</span> <span class="o">=</span> <span class="n">pwd</span><span class="o">()</span>

        <span class="c1">// based on this, construct the path to the workspace</span>
        <span class="n">String</span> <span class="n">workspacePath</span> <span class="o">=</span> <span class="n">PWD</span><span class="o">.</span><span class="na">substring</span><span class="o">(</span><span class="n">PWD</span><span class="o">.</span><span class="na">lastIndexOf</span><span class="o">(</span><span class="s1">'/'</span><span class="o">)</span> <span class="o">+</span> <span class="mi">1</span><span class="o">,</span> <span class="n">PWD</span><span class="o">.</span><span class="na">length</span><span class="o">())</span>

        <span class="c1">// read our HTML report into a String</span>
        <span class="n">String</span> <span class="n">report</span> <span class="o">=</span> <span class="n">readFile</span> <span class="o">(</span><span class="s2">"${env.PWD}/workspace/${workspacePath}/cucumber_report.html"</span><span class="o">)</span>

        <span class="c1">// split each line break into its own String</span>
        <span class="n">String</span><span class="o">[]</span> <span class="n">lines</span> <span class="o">=</span> <span class="n">report</span><span class="o">.</span><span class="na">split</span><span class="o">(</span><span class="s2">"\n"</span><span class="o">)</span>

        <span class="c1">// use regex to find the "passed" line and "failed" line</span>
        <span class="kt">def</span> <span class="n">foundPassedLine</span> <span class="o">=</span> <span class="n">lines</span><span class="o">.</span><span class="na">find</span><span class="o">{</span> <span class="n">line</span><span class="o">-&gt;</span> <span class="n">line</span> <span class="o">=~</span> <span class="s">/\&lt;span class="label label-success" title=scenarios\&gt;/</span> <span class="o">}</span>
        <span class="kt">def</span> <span class="n">foundFailedLine</span> <span class="o">=</span> <span class="n">lines</span><span class="o">.</span><span class="na">find</span><span class="o">{</span> <span class="n">line</span><span class="o">-&gt;</span> <span class="n">line</span> <span class="o">=~</span> <span class="s">/\&lt;span class="label label-danger" title=scenarios\&gt;/</span> <span class="o">}</span>

        <span class="c1">// match for the numeric values</span>
        <span class="kt">def</span> <span class="n">passedMatch</span> <span class="o">=</span> <span class="o">(</span><span class="n">foundPassedLine</span> <span class="o">=~</span> <span class="s">/[0-9]+/</span><span class="o">)</span>
        <span class="kt">def</span> <span class="n">failedMatch</span> <span class="o">=</span> <span class="o">(</span><span class="n">foundFailedLine</span> <span class="o">=~</span> <span class="s">/[0-9]+/</span><span class="o">)</span>

        <span class="c1">// cast to Integer so we can work with the number values</span>
        <span class="n">e2ePassed</span> <span class="o">=</span> <span class="n">passedMatch</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span> <span class="k">as</span> <span class="n">Integer</span>
        <span class="n">e2eFailed</span> <span class="o">=</span> <span class="n">failedMatch</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span> <span class="k">as</span> <span class="n">Integer</span>
        <span class="n">e2eTotal</span> <span class="o">=</span> <span class="n">e2eFailed</span> <span class="o">+</span> <span class="n">e2ePassed</span>
        <span class="n">e2ePercent</span> <span class="o">=</span> <span class="n">e2ePassed</span> <span class="o">/</span> <span class="n">e2eTotal</span> <span class="o">*</span> <span class="mi">100</span>

        <span class="k">if</span> <span class="o">(</span><span class="n">e2eFailed</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
            <span class="c1">// do something extra if there are failures</span>
        <span class="o">}</span>

        <span class="c1">// print out our results to the console</span>
        <span class="n">println</span> <span class="o">(</span><span class="s2">"Passed: ${e2ePassed}"</span><span class="o">)</span>
        <span class="n">println</span> <span class="o">(</span><span class="s2">"Failed: ${e2eFailed}"</span><span class="o">)</span>
        <span class="n">println</span> <span class="o">(</span><span class="s2">"Percent passes: ${e2ePercent}%"</span><span class="o">)</span>
    <span class="o">}</span>

    <span class="c1">// we can also access these values in an `sh` declaration (or other functions) outside of `script` now</span>
    <span class="n">sh</span> <span class="s2">"echo \"Passed: ${e2ePassed}\""</span>
    <span class="n">sh</span> <span class="s2">"echo \"Failed: ${e2eFailed}\""</span>
    <span class="n">sh</span> <span class="s2">"echo \"Percent passes: ${e2ePercent}%\""</span>

    <span class="c1">// you may opt to use the vars in plugins like `slackSend`, etc</span>
<span class="o">}</span>
</code></pre></div></div> <p><strong>Note</strong>: The security settings for up-to-date Jenkins setups will trigger an error upon using <code class="highlighter-rouge">readFile</code> the first time. When this happens, go to <code class="highlighter-rouge">Manage Jenkins</code> and <code class="highlighter-rouge">In-process Script Approval</code>. You’ll see a prompt to allow the readFile for use in the specific Jenkinsfile in all future job runs. You must be an admin to approve this.</p> <p>Once you have this data extracted from the reporter, you could use it notify external systems when there are failures, or to keep a running track of test pass/failure metrics. <img src="http://robporter.ca/assets/img/feather-7.svg" style="width:33px;height:33px;display:inline;padding-left:6px"></p> <div class="entry-meta"> <br> <hr> <span class="entry-tags"><a href="http://localhost:4000/tags/#Groovy" title="Pages tagged Groovy" class="tag"><span class="term">Groovy</span></a><a href="http://localhost:4000/tags/#Jenkins" title="Pages tagged Jenkins" class="tag"><span class="term">Jenkins</span></a><a href="http://localhost:4000/tags/#Java" title="Pages tagged Java" class="tag"><span class="term">Java</span></a><a href="http://localhost:4000/tags/#E2E" title="Pages tagged E2E" class="tag"><span class="term">E2E</span></a><a href="http://localhost:4000/tags/#Cucumber" title="Pages tagged Cucumber" class="tag"><span class="term">Cucumber</span></a></span> <span class="social-share"> <a href="https://www.facebook.com/sharer/sharer.php?u=http://localhost:4000/jenkins-cucumber/" title="Share on Facebook" class="tag"> <span class="term"><i class="fa fa-facebook-square"></i> Like</span> </a> <a href="https://twitter.com/intent/tweet?text=http://localhost:4000/jenkins-cucumber/" title="Share on Twitter" class="tag"> <span class="term"><i class="fa fa-twitter-square"></i> Tweet</span> </a> <a href="https://plus.google.com/share?url=http://localhost:4000/jenkins-cucumber/" title="Share on Google+" class="tag"> <span class="term"><i class="fa fa-google-plus-square"></i> +1</span> </a> </span> <div style="clear:both"></div> </div> </div> </div> </header> <!-- JS --> <script src="http://localhost:4000/assets/js/jquery-1.12.0.min.js"></script> <script src="http://localhost:4000/assets/js/jquery.dlmenu.min.js"></script> <script src="http://localhost:4000/assets/js/jquery.goup.min.js"></script> <script src="http://localhost:4000/assets/js/jquery.magnific-popup.min.js"></script> <script src="http://localhost:4000/assets/js/jquery.fitvid.min.js"></script> <script src="http://localhost:4000/assets/js/scripts.js"></script> <!-- MathJax --> <script async src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script> </body> </html>
